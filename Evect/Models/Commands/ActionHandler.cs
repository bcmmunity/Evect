using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Mail;
using System.Reflection;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using Evect.Models.DB;
using Microsoft.EntityFrameworkCore;
using Telegram.Bot;
using Telegram.Bot.Requests;
using Telegram.Bot.Types;
using Telegram.Bot.Types.Enums;
using Telegram.Bot.Types.ReplyMarkups;

namespace Evect.Models.Commands
{
    public class ActionHandler
    {
        private readonly CommandHandler _commandHadler = new CommandHandler();

        [UserAction(Actions.None)]
        public async Task OnNone(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var commands = Bot.Commands;
            var chatId = message.Chat.Id;
            var text = message.Text;

            foreach (var pair in commands)
            {
                if (pair.Value == text)
                {
                    pair.Key(context, message, client);
                    return;
                }
            }

            await client.SendTextMessageAsync(
                chatId,
                "–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é –≤–∞—Å",
                ParseMode.Markdown);
        }


        [UserAction(Actions.WaitingForEventCode)]
        public async Task OnWaitingEventCode(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;
            EventDB eventDb = new EventDB();


            User user = await UserDB.GetUserByChatId(context, chatId);
            

            bool isValid = await eventDb.IsEventCodeValid(text);
            if (isValid)
            {
                Event ev = await context.Events.FirstOrDefaultAsync(e =>
                    e.EventCode == text || e.AdminCode == text);

                bool have = user.UserEvents.FirstOrDefault(ue => ue.EventId == ev.EventId) != null;

                bool isAdminCode = await eventDb.IsAdminCode(text);


                if (isAdminCode)
                {
                    TelegramKeyboard keyboard = new TelegramKeyboard();
                    keyboard.AddRow("–û–± –∏–≤–µ–Ω—Ç–µ");
                    keyboard.AddRow("–ò–Ω–≤–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö");
                    keyboard.AddRow("–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å");
                    keyboard.AddRow("–°–æ–∑–¥–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ");
                    
                    UserDB.AdminAuthorized(context, chatId);
                    UserDB.ChangeUserAction(context, chatId, Actions.AdminMode);
                    if (!have)
                    {
                        UserEvent userEvent = new UserEvent() { UserId = user.UserId, EventId = ev.EventId };
                        user.UserEvents.Add(userEvent);
                        user.CurrentEventId = ev.EventId;
                        //–ø–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç,–∫–æ–≥–¥–∞ —ç—Ç–æ —Ä–∞—Å–∫–æ–º–µ–Ω—á–µ–Ω–æ?
                        context.Users.Update(user);
                        context.SaveChanges();
                    }
                    await client.SendTextMessageAsync(chatId, 
                        $"–í–∫–ª—é—á—ë–Ω —Ä–µ–∂–∏–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ \"{ev.Name}\"" 
                        + "üòá".ToString() + "\n" + "–í–∞–º –¥–æ—Å—Ç—É–ø–µ–Ω —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:\n\n" 
                        + "0Ô∏è‚É£".ToString() 
                        + "<b>–û–± –∏–≤–µ–Ω—Ç–µ</b>- –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏" 
                        + "1Ô∏è‚É£".ToString() 
                        + "–ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å <b>–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º</b\n"
                        + "2Ô∏è‚É£".ToString() 
                        + "<b>–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</b>- –æ–ø—Ä–æ—Å —Ä–∞—Å—Å—ã–ª–∞–µ—Ç—Å—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º, —Ç–∏–ø –æ–ø—Ä–æ—Å–∞- –æ—Ü–µ–Ω–∫–∞ –æ—Ç 1 –¥–æ 5\n" 
                        + "3Ô∏è‚É£".ToString() 
                        + "<b>–°–æ–∑–¥–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ</b>- —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º", 
                        ParseMode.Html, replyMarkup: keyboard.Markup);
                }
                else
                {
                    if (have)
                    {
                        await client.SendTextMessageAsync(
                            chatId,
                            "–í—ã —É–∂–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —ç—Ç–æ–º—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é",
                            ParseMode.Markdown);


                        UserDB.ChangeUserAction(context, chatId, Actions.Profile);
                        TelegramKeyboard keyboard = new TelegramKeyboard();
                        keyboard.AddRow("–û –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏", "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é");
                        keyboard.AddRow("–†–µ–∂–∏–º –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞");
                        keyboard.AddRow("–ó–∞–ø–∏—Å–Ω–∞—è –∫–Ω–∏–∂–∫–∞");
                        keyboard.AddRow("–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è");
                        await client.SendTextMessageAsync(
                            chatId,
                            "–ß—Ç–æ –Ω—É–∂–Ω–æ?",
                            ParseMode.Markdown,
                            replyMarkup: keyboard.Markup);
                    }
                    else
                    {

                        UserEvent userEvent = new UserEvent()
                        {
                            UserId = user.UserId,
                            EventId = ev.EventId
                        };

                        user.UserEvents.Add(userEvent);
                        user.CurrentEventId = ev.EventId;
                        context.Users.Update(user);
                        context.SaveChanges();



                        await client.SendTextMessageAsync(
                            chatId,
                            $"–í—ã –ø–æ–¥–∫–ª—é—á–∞–µ—Ç–µ—Å—å –∫ *{ev.Name}*",
                            ParseMode.Markdown);

                        StringBuilder builder = new StringBuilder();

                        if (string.IsNullOrEmpty(user.FirstName) || string.IsNullOrEmpty(user.LastName))//–∑–¥–µ—Å—å –º–± —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∞–¥–º–∏–Ω—Å–∫–∏–π –ª–∏ –∫–æ–¥
                        {
                            await client.SendTextMessageAsync(
                                chatId,
                                "–ê —Ç–µ–ø–µ—Ä—å –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è. –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?",
                                ParseMode.Markdown);
                            UserDB.ChangeUserAction(context, chatId, Actions.WaitingForName);

                        } else if (string.IsNullOrEmpty(user.Email))
                        {
                            builder.AppendLine(@"–í–æ—Ç –º—ã –∏ –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å‚úåÔ∏è");
                            builder.AppendLine("–ê —Ç–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å *—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã*");
                            builder.AppendLine();
                            builder.AppendLine("ü§ñ –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∞—à–µ–≥–æ *–ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞*, –æ–Ω —É–ø—Ä–æ—Å—Ç–∏—Ç –≤—Ö–æ–¥ –≤ —Å–ª—É—á–∞–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞, –∞ —Ç–∞–∫–∂–µ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
                            
                            await client.SendTextMessageAsync(
                                chatId,
                                builder.ToString(),
                                ParseMode.Markdown);
                            UserDB.ChangeUserAction(context, chatId, Actions.WainingForEmail);
                        }
                        else
                        {
                            TelegramKeyboard keyboard = new TelegramKeyboard();
                            keyboard.AddRow("–û –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏", "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é");
                            keyboard.AddRow("–†–µ–∂–∏–º –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞");
                            keyboard.AddRow("–ó–∞–ø–∏—Å–Ω–∞—è –∫–Ω–∏–∂–∫–∞");
                            keyboard.AddRow("–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è");
                            await client.SendTextMessageAsync(
                                chatId,
                                "–ß—Ç–æ –Ω—É–∂–Ω–æ?",
                                ParseMode.Markdown,
                                replyMarkup: keyboard.Markup);

                            UserDB.ChangeUserAction(context, chatId, Actions.Profile);
                        }
                    }
                }
            }
            else
            {
                await client.SendTextMessageAsync(
                    chatId,
                    $"–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥(",
                    ParseMode.Markdown);
            }
        }
        #region AdminModeAndAdminActions
        [UserAction(Actions.AdminMode)]
        public async Task AdminMode(ApplicationContext context, Message message, TelegramBotClient client)
        {
            if (message.Text == "–û–± –∏–≤–µ–Ω—Ç–µ")
            {
                EventDB eventDb = new EventDB();
                long chatId = message.Chat.Id;
                User user = await UserDB.GetUserByChatId(context, chatId);
                if (!user.IsAdminAuthorized)
                {
                    await client.SendTextMessageAsync(chatId, "–Ø –Ω–µ –∑–Ω–∞—é —Ç–∞–∫–æ–π –∫–æ–º–∞–Ω–¥—ã –ø–æ–∫–∞");
                }
                else
                {
                    TelegramKeyboard keyboard = new TelegramKeyboard();
                    keyboard.AddRow("–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç–∞—Ç—å—é");
                    keyboard.AddRow("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å");
                    keyboard.AddRow("–ù–∞–∑–∞–¥");
                    UserDB.ChangeUserAction(context, chatId, Actions.GetInformationAboutTheEvent);
                    string info = eventDb.GetInfoAboutTheEvent(chatId);
                    await client.SendTextMessageAsync(chatId, info, replyMarkup:keyboard.Markup);
                }
            }
            else if(message.Text=="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö")
             {
                TelegramKeyboard keyboard = new TelegramKeyboard();
                var chatId = message.Chat.Id;
                keyboard.AddRow("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π");
                keyboard.AddRow("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π —Ä–µ–∂–∏–º–∞ –æ–±—â–µ–Ω–∏—è");
                keyboard.AddRow("–ß–∏—Å–ª–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤");
                keyboard.AddRow("–ß–∏—Å–ª–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—Å—Ç—Ä–µ—á");
                keyboard.AddRow("–ù–∞–∑–∞–¥");
                UserDB.ChangeUserAction(context, chatId, Actions.InformationAboutUsers);
                await client.SendTextMessageAsync(chatId, "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –í–∞—Å –ø—É–Ω–∫—Ç",replyMarkup: keyboard.Markup);
               // await client.SendTextMessageAsync(chatId, "–≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—á–µ–Ω—å —Å–∫–æ—Ä–æ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã" + "üòÖ".ToString(), ParseMode.Markdown);
             }
            else if (message.Text == "–°–æ–∑–¥–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ")
            {
                //EventDB eventDB = new EventDB();
                long chatId = message.Chat.Id;
                TelegramKeyboard keyboard = new TelegramKeyboard();
                keyboard.AddRow("–ù–∞–∑–∞–¥");
                UserDB.ChangeUserAction(context, chatId, Actions.CreateNotification);
                await client.SendTextMessageAsync(chatId, "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ,–æ–Ω–æ –±—É–¥–µ—Ç —Ä–∞–∑–æ—Å–ª–∞–Ω–æ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è", replyMarkup: keyboard.Markup);
            }
            /*if(message.Text=="–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å")
            {

            }*/
        }

        [UserAction(Actions.GetInformationAboutTheEvent)]
        public async Task InformationAboutTheEvent(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;

            TelegramKeyboard backKeyboard = new TelegramKeyboard();
            backKeyboard.AddRow("–ù–∞–∑–∞–¥");
            
            if (text == "–ù–∞–∑–∞–¥")
            {
                

                TelegramKeyboard keyboard = new TelegramKeyboard();
                keyboard.AddRow("–û–± –∏–≤–µ–Ω—Ç–µ");
                keyboard.AddRow("–ò–Ω–≤–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö");
                keyboard.AddRow("–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å");
                keyboard.AddRow("–°–æ–∑–¥–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ");
                
                UserDB.ChangeUserAction(context, chatId, Actions.AdminMode);
                await client.SendTextMessageAsync(chatId, "–Ø –≤–µ—Ä–Ω—É–ª—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", replyMarkup: keyboard.Markup);
            }
            else if (text == "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å")
            {
                UserDB.ChangeUserAction(context, chatId, Actions.EditInformationAboutEvent);
                EventDB eventDb = new EventDB();
                string info = eventDb.GetInfoAboutTheEvent(chatId);

                // await client.SendTextMessageAsync(chatId, "–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏", replyMarkup: backKeybaord.Markup);

            }
            else if (text == "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç–∞—Ç—å—é")
            {
                UserDB.ChangeUserAction(context, chatId, Actions.AddNewInformationAboutEvent);
                string[][] back = { new[] { "–ù–∞–∑–∞–¥" } };
                await client.SendTextMessageAsync(chatId, "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Ç–∞—Ç—å—é –æ–±—ã—á–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º", replyMarkup: backKeyboard.Markup);
            }
            else
            {
                EventDB eventDb = new EventDB();
                eventDb.AddInformationAboutEvent(chatId, text);
                await client.SendTextMessageAsync(chatId, "–î–∞–Ω–Ω—ã–µ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
            }


        }
        [UserAction(Actions.AddNewInformationAboutEvent)]//"–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç–∞—Ç—å—é"
        public async Task AddInfoAboutEvent(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;
            EventDB eventDb = new EventDB();
            
            TelegramKeyboard keyboard = new TelegramKeyboard();
            keyboard.AddRow("–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç–∞—Ç—å—é");
            keyboard.AddRow("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å");
            keyboard.AddRow("–ù–∞–∑–∞–¥");
            
            UserDB.ChangeUserAction(context, chatId, Actions.GetInformationAboutTheEvent);
            if (message.Text == "–ù–∞–∑–∞–¥")
            {
                
                await client.SendTextMessageAsync(chatId, "–Ø –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞–∑–∞–¥", replyMarkup: keyboard.Markup);
            }
            else
            {
                eventDb.AddInformationAboutEvent(chatId, text);
                await client.SendTextMessageAsync(chatId, "–î–∞–Ω–Ω—ã–µ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã", replyMarkup: keyboard.Markup);
            }
        }
        [UserAction(Actions.CreateNotification)]//—Å–æ–∑–¥–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ
        public async Task SendNotification(ApplicationContext context,Message message,TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;
            if(message.Text=="–ù–∞–∑–∞–¥")
            {

                TelegramKeyboard keyboard = new TelegramKeyboard();
                keyboard.AddRow("–û–± –∏–≤–µ–Ω—Ç–µ");
                keyboard.AddRow("–ò–Ω–≤–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö");
                keyboard.AddRow("–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å");
                keyboard.AddRow("–°–æ–∑–¥–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ");
                
                UserDB.ChangeUserAction(context, chatId, Actions.AdminMode);
                
                await client.SendTextMessageAsync(chatId, "–Ø –≤–µ—Ä–Ω—É–ª—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", replyMarkup: keyboard.Markup);
            }
            else
            {
                EventDB eventDb = new EventDB();
                List<long> usersToSend =await eventDb.GetAllParticipantsOfEvent(chatId);
                foreach(var item in usersToSend)
                {
                    await client.SendTextMessageAsync(item, text, ParseMode.Markdown);//–ø—Ä–æ–≤–µ—Ä–∏—Ç—å,—Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º?
                }
                await client.SendTextMessageAsync(chatId, "–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–æ—Å–ª–∞–Ω–æ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è");
            }
        }
        
        [UserAction(Actions.InformationAboutUsers)]
        public async Task GetInformationAboutUsers(ApplicationContext context,Message message,TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            EventDB eventDb = new EventDB();
            switch(message.Text)
            {
                case "–ù–∞–∑–∞–¥":
                    {
                        TelegramKeyboard keyboard = new TelegramKeyboard();
                        keyboard.AddRow("–û–± –∏–≤–µ–Ω—Ç–µ");
                        keyboard.AddRow("–ò–Ω–≤–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö");
                        keyboard.AddRow("–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å");
                        keyboard.AddRow("–°–æ–∑–¥–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ");
                        UserDB.ChangeUserAction(context, chatId, Actions.AdminMode);
                        await client.SendTextMessageAsync(chatId, "–Ø –≤–µ—Ä–Ω—É–ª—Å—è –Ω–∞–∑–∞–¥", replyMarkup: keyboard.Markup);
                    }
                    break;
                case "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π":
                    {
                        string amountOfUsers =await eventDb.GetInfrormationAboutUsers(chatId,message.Text);
                        await client.SendTextMessageAsync(chatId, amountOfUsers);
                    }
                    break;
                case "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π —Ä–µ–∂–∏–º–∞ –æ–±—â–µ–Ω–∏—è":
                    {
                        string amountOfActivationOfNetworkingMode =await eventDb.GetInfrormationAboutUsers(chatId, message.Text);
                        await client.SendTextMessageAsync(chatId,amountOfActivationOfNetworkingMode);
                    }
                    break;
                case "–ß–∏—Å–ª–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤":
                    {
                        string amountOfRequestsOfContacts =await eventDb.GetInfrormationAboutUsers(chatId, message.Text);
                        await client.SendTextMessageAsync(chatId,amountOfRequestsOfContacts);
                    }
                    break;
                case "–ß–∏—Å–ª–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—Å—Ç—Ä–µ—á":
                    {
                        string amountOfRequestsOfMeetings =await eventDb.GetInfrormationAboutUsers(chatId, message.Text);
                        await client.SendTextMessageAsync(chatId, amountOfRequestsOfMeetings);
                    }
                    break;
            }
            }
         #endregion
        [UserAction(Actions.WaitingForName)]
        public async Task OnWaitingForName(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;
            EventDB eventDb = new EventDB();
            

            User user = await UserDB.GetUserByChatId(context, chatId);

            var names = text.Split(' ');
            if (names.Length == 2)
            {
                user.FirstName = names[0];
                user.LastName = names[1];
                context.Update(user);
                context.SaveChanges();
                StringBuilder builder = new StringBuilder();
                
                if (string.IsNullOrEmpty(user.Email))
                {
                    builder.AppendLine(@"–í–æ—Ç –º—ã –∏ –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å‚úåÔ∏è");
                    builder.AppendLine("–ê —Ç–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å *—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã*");
                    builder.AppendLine();
                    builder.AppendLine("ü§ñ –û–Ω –Ω—É–∂–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∞—à–µ–≥–æ *–ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞*, –æ–Ω —É–ø—Ä–æ—Å—Ç–∏—Ç –≤—Ö–æ–¥ –≤ —Å–ª—É—á–∞–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞, –∞ —Ç–∞–∫–∂–µ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
                    await client.SendTextMessageAsync(
                        chatId,
                        builder.ToString(),
                        ParseMode.Markdown);
                    UserDB.ChangeUserAction(context, chatId, Actions.WainingForEmail);
                }
            }
            else
            {
                await client.SendTextMessageAsync(
                    chatId,
                    "–í–≤–µ–¥–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é",
                    ParseMode.Markdown);
            }
        }

        [UserAction(Actions.WainingForEmail)]
        public async Task OnWaitingForEmail(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;
            

            User user = await UserDB.GetUserByChatId(context, chatId);
            
            if (Utils.IsEmailValid(text))
            {
                if (await UserDB.CheckEmailInDB(context, text))
                {
                    await client.SendTextMessageAsync(
                        chatId,
                        "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —ç—Ç–æ–π –ø–æ—á—Ç–æ–π —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –¥—Ä—É–≥–æ–π –∞–∫–∫–∞—É–Ω—Ç —Ç–µ–ª–µ–≥—Ä–∞–º. –ù–∞ —ç—Ç—É –ø–æ—á—Ç—É –æ—Ç–ø–∞—Ä–≤–ª–µ–Ω –∫–æ–¥ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥",
                        ParseMode.Markdown);

                    string code = Utils.GenerateRandomCode();
                    await Utils.SendEmailAsync(text, "–ü–æ—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ—á—Ç—ã", $"–í–∞—à –∫–æ–¥–∞ –¥–ª—è –ø–æ—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ—á—Ç—ã: {code}");
                    UserDB.ChangeUserAction(context, chatId, Actions.WaitingForValidationCode);
                    context.Validations.Add(new UserValidation
                    {
                        UserTelegramId = chatId,
                        Code = code, 
                        Email = text
                    });
                    context.SaveChanges();
                }
                else
                {
                    user.Email = text;
                    context.Update(user);
                    context.SaveChanges();
                
                    TelegramKeyboard keyboard = new TelegramKeyboard();
                    keyboard.AddRow("–û –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏", "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é");
                    keyboard.AddRow("–†–µ–∂–∏–º –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞");
                    keyboard.AddRow("–ó–∞–ø–∏—Å–Ω–∞—è –∫–Ω–∏–∂–∫–∞");
                    keyboard.AddRow("–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è");

                    await client.SendTextMessageAsync(
                        chatId,
                        "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ, –≤–∞–º –¥–æ—Å—Ç—É–ø–µ–Ω –≤–µ—Å—å –º–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª",
                        ParseMode.Markdown,
                        replyMarkup: keyboard.Markup);
                    UserDB.ChangeUserAction(context, chatId, Actions.Profile);
                }

            }
            else
            {
                await client.SendTextMessageAsync(
                    chatId,
                    "–í–≤–µ–¥–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—á—Ç—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ",
                    ParseMode.Markdown);
            }
            
        }

        [UserAction(Actions.WaitingForValidationCode)]
        public async Task OnWaitingForValidationCode(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var text = message.Text;
            var chatId = message.Chat.Id;
            

            User user = await UserDB.GetUserByChatId(context, chatId);
            UserValidation val = context.Validations.FirstOrDefault(v => v.UserTelegramId == chatId);
            if (val != null)
            {
                if (val.Code == text)
                {

                    User old = context.Users.FirstOrDefault(u => u.Email == val.Email);
                    if (old != null)
                    {
                        context.Users.Remove(old);
                        context.Validations.Remove(val);
                    }
                    
                    user.Email = val.Email;
                    context.Users.Update(user);

                    context.SaveChanges();
                    
                    await client.SendTextMessageAsync(
                        chatId,
                        "–ü–æ—á—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞",
                        ParseMode.Markdown);
                    
                    
                    TelegramKeyboard keyboard = new TelegramKeyboard();
                    keyboard.AddRow("–û –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏", "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é");
                    keyboard.AddRow("–†–µ–∂–∏–º –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞");
                    keyboard.AddRow("–ó–∞–ø–∏—Å–Ω–∞—è –∫–Ω–∏–∂–∫–∞");
                    keyboard.AddRow("–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è");
                    await client.SendTextMessageAsync(
                        chatId,
                        "–ß—Ç–æ –Ω—É–∂–Ω–æ?",
                        ParseMode.Markdown,
                        replyMarkup: keyboard.Markup);
                    
                    UserDB.ChangeUserAction(context, chatId, Actions.Profile);
                    
                }
                else
                {
                    await client.SendTextMessageAsync(
                        chatId,
                        "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥",
                        ParseMode.Markdown);
                }
            }

            

        }
        
        
        [UserAction(Actions.DeleteOrNot)]
        public async Task OnDeleteOrNot(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;
            

            User user = await UserDB.GetUserByChatId(context, chatId);
            
            if (text == "–î–∞")
            {
                UserDB.UserLogoff(context, chatId);
                UserDB.ResetAction(context, chatId);
                await client.SendTextMessageAsync(
                    chatId,
                    "–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–∫—Ä–∞—Ç–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è evectbot, –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ –Ω–∞–ø–∏—à–∏—Ç–µ <em>/start</em>",
                    ParseMode.Markdown);
            }
            else if (text == "–ù–µ—Ç")
            {
                context.Users.Remove(user);
                context.SaveChanges();
                await client.SendTextMessageAsync(
                    chatId,
                    "–í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞, –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ –Ω–∞–ø–∏—à–∏—Ç–µ <em>/start</em>",
                    ParseMode.Markdown);
            }
            else
            {
                await client.SendTextMessageAsync(
                    chatId,
                    "–î–∞/–ù–µ—Ç",
                    ParseMode.Markdown);
            }
        }
        
        
        [UserAction(Actions.Profile)]
        public async Task OnProfile(ApplicationContext context, Message message, TelegramBotClient client)
        {
            
            EventDB eventDb = new EventDB();
            var chatId = message.Chat.Id;
            var text = message.Text;

            User user = await UserDB.GetUserByChatId(context, chatId);
            StringBuilder builder = new StringBuilder();

            TelegramKeyboard keyboard;
            switch (text)
            {
                case "–û –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏":
                    bool isReg = user.CurrentEventId > 0;
                    if (isReg)
                    {
                        Event ev = context.Events.Find(user.CurrentEventId);
                        string linkType = ev.TelegraphLink.Contains("telegra.ph") ? "Telegraph" : "Teletype";
                        builder.Clear();
                        
                        builder.AppendLine($"<b>–ù–∞–∑–≤–∞–Ω–∏–µ: </b>{ev.Name}");
                        builder.AppendLine($"–î–ª—è –≤–∞—à–µ–≥–æ —É–¥–æ–±—Å—Ç–≤–∞ –º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ —Å—Ç–∞—Ç—å—é –≤ {linkType}: {ev.TelegraphLink}");

                        await client.SendTextMessageAsync(
                            chatId,
                            builder.ToString(),
                            ParseMode.Markdown);
                        keyboard = new TelegramKeyboard();
                        keyboard.AddRow("–û –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏", "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é");
                        keyboard.AddRow("–†–µ–∂–∏–º –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞");
                        keyboard.AddRow("–ó–∞–ø–∏—Å–Ω–∞—è –∫–Ω–∏–∂–∫–∞");
                        keyboard.AddRow("–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è");
                        await client.SendTextMessageAsync(chatId, "–ß—Ç–æ –Ω—É–∂–Ω–æ?",ParseMode.Markdown,replyMarkup: keyboard.Markup);
                    }
                    else
                    {
                        await client.SendTextMessageAsync(
                            chatId,
                            $"–í—ã –Ω–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –Ω–∏ –∫ –æ–¥–Ω–æ–º—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é",
                            ParseMode.Markdown);
                    }
                    break;
                
                case "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é":
                    await client.SendTextMessageAsync(
                        chatId,
                        "–í–µ–µ–¥–∏—Ç–µ –∏–≤–µ–Ω—Ç –∫–æ–¥",
                        ParseMode.Markdown);
                    UserDB.ChangeUserAction(context, chatId, Actions.WaitingForEventCode);
                    break;
                
                
                case "–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è":


                    var events = Utils.SplitList(2, (await eventDb.GetUserEvents(chatId)).Select(e => e.Name).ToList());
                    

                    List<string> temp = events[0];
                    temp[0] = $"{temp[0]} {Utils.GetCheckmark()}";

                    var forKeyboard = Utils.SplitList(1, temp);

                    string cont = events.Count > 1 ? "2" : "|";
                    
                    forKeyboard.Add(new List<string> {"|", "X", $"{cont}"});

                    keyboard = new TelegramKeyboard();
                    
                    foreach (var list in forKeyboard)
                    {
                        keyboard.AddRow(list);
                    }
                    
                    
                    await client.SendTextMessageAsync(
                        chatId,
                        "–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è",
                        ParseMode.Markdown,
                        replyMarkup: keyboard.Markup);
                    
                    UserDB.ChangeUserAction(context, chatId, Actions.AllEventsChangePage);
                    
                    break;
                
                case "–†–µ–∂–∏–º –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞":
                    if (user.CompanyAndPosition == null) // TODO: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–æ, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    {
                        //–û–¢ –õ–ò–ó–´
                        eventDb.AddInfoAboutUsers(chatId, "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π —Ä–µ–∂–∏–º–∞ –æ–±—â–µ–Ω–∏—è");
                        UserDB.ChangeUserAction(context, chatId, Actions.FirstQuestion);
                        //–ö–û–ù–ï–¶ –û–¢ –õ–ò–ó–´

                        // Phrase shows user that mode has changed
                        await client.SendTextMessageAsync(
                            chatId,
                            "**–ì–¥–µ –∏ –∫–µ–º –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ? [1/3]**\n\n–î–ª—è **—Ä–µ–∂–∏–º–∞ –æ–±—â–µ–Ω–∏—è** –∂–∏–∑–Ω–µ–Ω–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è ‚Äì **3 –≤–æ–ø—Ä–æ—Å–∞ –∏ 2 —ç—Ç–∞–ø–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–≥–æ–≤** (—Ç–µ–≥ ‚Äì —Å—Ñ–µ—Ä–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞, —É–ø—Ä–æ—â–∞–µ—Ç –ø–æ–∏—Å–∫ –Ω—É–∂–Ω—ã—Ö –≤–∞–º –ª—é–¥–µ–π).\n\n–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º üôÉ",
                            ParseMode.Markdown);
                        // First question
                        await client.SendTextMessageAsync(
                            chatId,
                            "–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ª—é–¥—è–º –ø–æ–Ω—è—Ç—å, —á–µ–º –≤—ã –º–æ–∂–µ—Ç–µ –±—ã—Ç—å –∏–º –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω. –ü—Ä–∏—à–ª–∏ –º–Ω–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ —Ç–≤–æ—é –¥–æ–ª–∂–Ω–æ—Å—Ç—å. __–ù–∞–ø—Ä–∏–º–µ—Ä__, \"–î–∏–∑–∞–π–Ω–µ—Ä –≤ –Ø–Ω–¥–µ–∫—Å\"",
                            ParseMode.Markdown);
                    }
                    else
                    {
                        UserDB.ChangeUserAction(context, chatId, Actions.Networking);   
                    }

                    break;

                default:
                    await client.SendTextMessageAsync(
                        chatId,
                        "—á–æ—Ç –Ω–µ —Ç–æ",
                        ParseMode.Markdown);
                    break;
            }
        }

        [UserAction(Actions.AllEventsChangePage)]
        public async Task OnEventsChangePage(ApplicationContext context, Message message, TelegramBotClient client)
        {
            EventDB eventDb = new EventDB();
            
            var text = message.Text;
            var chatId = message.Chat.Id;
            var events = Utils.SplitList(2, (await eventDb.GetUserEvents(chatId)).Select(e => e.Name).ToList());

            User user = await UserDB.GetUserByChatId(context, chatId);

            TelegramKeyboard keyboard;
            
            if (text == "X")
            {
                keyboard = new TelegramKeyboard(true);
                keyboard.AddRow("–û –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏", "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é");
                keyboard.AddRow("–†–µ–∂–∏–º –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞");
                keyboard.AddRow("–ó–∞–ø–∏—Å–Ω–∞—è –∫–Ω–∏–∂–∫–∞");
                keyboard.AddRow("–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è");
                await client.SendTextMessageAsync(chatId, "–ß—Ç–æ –Ω—É–∂–Ω–æ?",ParseMode.Markdown,replyMarkup: keyboard.Markup);
                UserDB.ChangeUserAction(context, chatId, Actions.Profile);
            }
            
            if (int.TryParse(text, out int n))
            {
                int page = Convert.ToInt32(text);

                if (page <= events.Count && page > 0)
                {

                    for (var i = 0; i < events[page - 1].Count; i++)
                    {
                        string t = events[page - 1][i];
                        if (eventDb.Context.Events.Find(user.CurrentEventId).Name == t)
                        {
                            events[page - 1][i] = $"{t} {Utils.GetCheckmark()}";
                            break;
                        }
                    }

                    string left = page - 1 > 0 ? $"{page - 1}" : "|";
                    string right = page + 1 < events.Count ? $"{page + 1}" : "|";
                    

                    var forKeyboard = Utils.SplitList(1, events[page - 1]);

                    forKeyboard.Add(new List<string> {left, "X", right});
                    
                    
                    keyboard = new TelegramKeyboard();

                    foreach (var list in forKeyboard)
                    {
                        keyboard.AddRow(list);
                    }
                    
                    await client.SendTextMessageAsync(
                        chatId,
                        "–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è",
                        ParseMode.Markdown,
                        replyMarkup: keyboard.Markup);
                }
                
            }
            else
            {
                if (text.Contains(Utils.GetCheckmark()))
                {
                    text = text.Substring(0, text.Length - 2);
                }
                
                var evs = await eventDb.GetUserEvents(chatId);
                foreach (var ev in evs)
                {
                    if (ev.Name == text)
                    {
                        user.CurrentEventId = ev.EventId;
                        break;
                    }
                }

                context.Update(user);
                context.SaveChanges();
            }
        }
        
        
        #region Network mode
        [UserAction(Actions.FirstQuestion)]
        public async Task OnFirstQuestion(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;
            

            User user = await UserDB.GetUserByChatId(context, chatId);

            user.CompanyAndPosition = text;
            
            UserDB.ChangeUserAction(context, chatId, Actions.SecondQuestion);
            await client.SendTextMessageAsync(
                chatId, "–¢–µ–ø–µ—Ä—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ãüòú \n**–ß–µ–º –≤—ã –º–æ–∂–µ—Ç–µ –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã? [2/3]**", ParseMode.Markdown);
        }

        [UserAction(Actions.SecondQuestion)]
        public async Task OnSecondQuestion(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;
            

            User user = await UserDB.GetUserByChatId(context, chatId);

            user.Utility = text;

            UserDB.ChangeUserAction(context, chatId, Actions.ThirdQuestion);
            await client.SendTextMessageAsync(
                chatId, "–ë–æ–ª–µ–µ –æ—Ç–≤–ª–µ—á—ë–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Åü§ó\n**–û —á–µ–º –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –ø–æ–æ–±—â–∞—Ç—å—Å—è? [3/3]**\n–¢–µ–º—ã —Ä–∞–±–æ—á–∏–µ –∏ –Ω–µ –æ—á–µ–Ω—å", ParseMode.Markdown);
        }
        
        [UserAction(Actions.ThirdQuestion)]
        public async Task OnThirdQuestion(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;
            
            User user = await UserDB.GetUserByChatId(context, chatId);
            
            TelegramKeyboard keyboard = new TelegramKeyboard(true);

            user.Communication = text;
            
            // For answer
            
            List<Tag> parentTags = context.Tags.Where(x => x.Level == 1).ToList();
            string[][] tags = new string[parentTags.Count-1][]; // Array of Tags of this Parent Tag (will be in DB, I guess) for INLINE keyboard
            int i = 0;
            
            foreach (var parentTag in parentTags)
            {
                keyboard.AddRow(parentTag.Name);
            }
            
            UserDB.ChangeUserAction(context, chatId, Actions.AddingParentTag);
            await client.SendTextMessageAsync(
                chatId, "üòã –•–æ—Ä–æ—à–æ, –ø–µ—Ä–µ–π–¥—ë–º –∫ **—Ç–µ–≥–∞–º**." +
                        "\n\n–ü–æ —Ç–µ–≥–∞–º –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –∏ —É–¥–æ–±–Ω–æ __—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å__ –Ω—É–∂–Ω—ã—Ö –≤–∞–º –ª—é–¥–µ–π. –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –≥—Ä—É–ø–ø—ã —Ç–µ–≥–æ–≤, –Ω–æ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ **–¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥** –º–æ–∂–Ω–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å—Å—è –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–æ–π" +
                        "\n\n–í—ã –º–æ–∂–µ—Ç–µ –∏—Ö –º–µ–Ω—è—Ç—å –ø–æ –∫–Ω–æ–ø–∫–µ –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å" +
                        "\n\n–ê —Å–µ–π—á–∞—Å –≤—ã–±–µ—Ä–∏—Ç–µ –í–ê–®–ò —Ç–µ–≥–∏ (–ø–æ–¥—Ö–æ–¥—è—Ç –ª–∏—á–Ω–æ **–í–ê–ú**) **[1/2]**", 
                ParseMode.Markdown, replyMarkup: keyboard.Markup);
        }

        #region Editing user
        
        [UserAction(Actions.AddingParentTag)]
        public async Task OnAddingTags(ApplicationContext context, Message message, TelegramBotClient client) // Adding parent tag here
        {
            // Add one tag and than more tags (next Action.ChoosingTags)
            var chatId = message.Chat.Id;
            var text = message.Text;
            
            User user = await UserDB.GetUserByChatId(context, chatId);
            Tag parentTag = context.Tags.FirstOrDefault(x => x.Name == text);

            UserTag userTag = new UserTag();
            userTag.TagId = parentTag.TagId;
            userTag.UserId = user.UserId;
            userTag.ForSearching = false;
            context.Users.Find(user).UserTags.Add(userTag); // Adding Parent Tag to User in DB
            context.SaveChanges();

            TelegramKeyboard keyboard = new TelegramKeyboard(true);
            TelegramInlineKeyboard inlineKeyboard = new TelegramInlineKeyboard();
            
            // Listing tags of this parent tag to user
            List<Tag> childTags = context.Tags.Where(x => x.Level == 2).ToList();
            string[][] tags = new string[childTags.Count-1][]; // Array of Tags of this Parent Tag (will be in DB, I guess) for INLINE keyboard
            string[][] callbackData = new string[childTags.Count-1][];
            int i = 0; 

            foreach (var tag in childTags)
            {
                inlineKeyboard
                    .AddTextRow(tag.Name) // Array of Tags of this Parent Tag (will be in DB, I guess) for INLINE keyboard
                    .AddCallbackRow(tag.TagId.ToString());
            }

            keyboard.AddRow("–û–∫"); // Variants of actions
            keyboard.AddRow("–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥");
            keyboard.AddRow("–í—ã–±—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ");

            // TODO: Add inline keyboard (tags)

            // TODO: Edit message with tags
            
            await client.SendTextMessageAsync(
                chatId, "", ParseMode.Markdown, // Editing while choosing tags?
                replyMarkup: keyboard.Markup);

            await client.SendTextMessageAsync(
                chatId, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥–∏: ", ParseMode.Markdown,
                replyMarkup: inlineKeyboard.Markup);
            
            UserDB.ChangeUserAction(context, chatId, Actions.ChoosingTags);
        }

        [UserAction(Actions.ChoosingTags)]
        public async Task OnChoosingTags(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;

            User user = await UserDB.GetUserByChatId(context, chatId);
            
            TelegramKeyboard keyboard = new TelegramKeyboard(true);
            TelegramInlineKeyboard inlineKeyboard = new TelegramInlineKeyboard();
            
            List<UserTag> userTags = context.UserTags.Where(x => x.UserId == user.UserId).ToList();
            List<Tag> parentTags = context.Tags.Where(x => x.Level == 1).ToList();
            string chosenTags = "";
            string[][] tags = new string[parentTags.Count-1][]; // Array of Tags of this Parent Tag (will be in DB, I guess) for INLINE keyboard

            // Gets users callbacks from inline keyboard and receiving answers from normal keyboard
            switch (text)
            {
                case "–û–ö": // Shows all Networking buttons 
                    if (context.UserTags.FirstOrDefault(x => x.UserId == user.UserId) != null)
                    {
                        foreach (var tag in user.UserTags.Where(x => x.UserId == user.UserId))
                        {
                            chosenTags += context.Tags.FirstOrDefault(x => x.TagId == tag.TagId && x.Level == 2).Name + " ";
                        }
                        
                        foreach (var parentTag in parentTags)
                        {
                            keyboard.AddRow(parentTag.Name);
                        }
                        
                        await client.SendTextMessageAsync(
                            chatId, "–í–∞—à–∏ —Ç–µ–≥–∏: " + chosenTags,
                            ParseMode.Markdown);

                        await client.SendTextMessageAsync(
                            chatId, "üòé –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥\n\n–í—ã–±–µ—Ä–∏—Ç–µ **—Ç–µ–≥–∏** –Ω—É–∂–Ω—ã—Ö –í–ê–ú –ª—é–¥–µ–π (**–í–´** –∏—Ö –∏—â–µ—Ç–µ) ‚Äì _—Ç–µ–≥–∏ –ø–æ–∏—Å–∫–∞_",
                            ParseMode.Markdown, replyMarkup: keyboard.Markup);
                        
                        UserDB.ChangeUserAction(context, chatId, Actions.SearchingParentTag);
                    }
                    else
                    {
                        await client.SendTextMessageAsync(
                            chatId, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥–∏!", ParseMode.Markdown);
                    }

                    break;
                
                case "–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥": // Add new parent tag
                    UserDB.ChangeUserAction(context, chatId, Actions.AddingParentTag);
                    
                    context.UserTags.RemoveRange(userTags); // Delete ALL previous tags

                    foreach (var parentTag in parentTags)
                    {
                        keyboard.AddRow(parentTag.Name);
                    }
                    
                    if (context.UserTags.FirstOrDefault(x => x.UserId == user.UserId) != null)
                    {
                        foreach (var tag in user.UserTags.Where(x => x.UserId == user.UserId))
                        {
                            chosenTags += context.Tags.FirstOrDefault(x => x.TagId == tag.TagId && x.Level == 1).Name + " "; 
                        }

                        await client.SendTextMessageAsync(
                            chatId, "–í—ã –≤—ã–±—Ä–∞–ª–∏: " + chosenTags, ParseMode.Markdown);
                    }
                    
                    await client.SendTextMessageAsync(
                        chatId, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø–æ–ª—å–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–≥:", 
                        ParseMode.Markdown, replyMarkup: keyboard.Markup);
                    break;
                
                case "–í—ã–±—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ": // Returns to Action with Parent Tags? Deletes all tags that user has now
                    UserDB.ChangeUserAction(context, chatId, Actions.AddingParentTag);
                    
                    context.UserTags.RemoveRange(userTags); // Delete ALL previous tags

                    foreach (var parentTag in parentTags)
                    {
                        keyboard.AddRow(parentTag.Name);
                    }
                    
                    await client.SendTextMessageAsync(
                        chatId, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥: ", 
                        ParseMode.Markdown, replyMarkup: keyboard.Markup);
                    break;
                
                default: // if it's a TagID, add it
                    try
                    {
                        int id = Convert.ToInt32(text);
                    }
                    catch
                    {
                        break;
                    }

                    if (context.Tags.FirstOrDefault(x => x.TagId == Convert.ToInt32(text)) != null)
                    {
                        Tag tag = context.Tags.FirstOrDefault(x => x.TagId == Convert.ToInt32(text));
                        
                        UserTag userTag = new UserTag();
                        userTag.TagId = tag.TagId;
                        userTag.UserId = user.UserId;
                        userTag.ForSearching = false;
                        context.UserTags.Add(userTag);
                        context.SaveChanges();
                        
                        await client.SendTextMessageAsync(
                            chatId, "–¢–µ–≥ " + tag.Name + " –¥–æ–±–∞–≤–ª–µ–Ω.", 
                            ParseMode.Markdown);
                        break;
                    }
                    else
                    {
                        break;
                    }
            }
        }
        #endregion
        
        [UserAction(Actions.SearchingParentTag)]
        public async Task OnSearchingParentTag(ApplicationContext context, Message message, TelegramBotClient client)
        {
                       // Add one tag and than more tags (next Action.ChoosingTags)
            var chatId = message.Chat.Id;
            var text = message.Text;
            
            User user = await UserDB.GetUserByChatId(context, chatId);
            Tag parentTag = context.Tags.FirstOrDefault(x => x.Name == text);

            UserTag userTag = new UserTag();
            userTag.TagId = parentTag.TagId;
            userTag.UserId = user.UserId;
            userTag.ForSearching = true;
            context.Users.Find(user).UserTags.Add(userTag); // Adding Parent Tag to User in DB
            context.SaveChanges();

            TelegramKeyboard keyboard = new TelegramKeyboard(true);
            TelegramInlineKeyboard inlineKeyboard = new TelegramInlineKeyboard();
            
            // Listing tags of this parent tag to user
            List<Tag> childTags = context.Tags.Where(x => x.Level == 2).ToList();
            string[][] tags = new string[childTags.Count-1][]; // Array of Tags of this Parent Tag (will be in DB, I guess) for INLINE keyboard
            string[][] callbackData = new string[childTags.Count-1][];
            int i = 0; 

            foreach (var tag in childTags)
            {
                inlineKeyboard
                    .AddTextRow(tag.Name) // Array of Tags of this Parent Tag (will be in DB, I guess) for INLINE keyboard
                    .AddCallbackRow(tag.TagId.ToString());
            }

            keyboard.AddRow("–û–∫"); // Variants of actions
            keyboard.AddRow("–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥");
            keyboard.AddRow("–í—ã–±—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ");

            // TODO: Add inline keyboard (tags)

            // TODO: Edit message with tags
            
            await client.SendTextMessageAsync(
                chatId, "", ParseMode.Markdown, // Editing while choosing tags?
                replyMarkup: keyboard.Markup);

            await client.SendTextMessageAsync(
                chatId, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥–∏: ", ParseMode.Markdown,
                replyMarkup: inlineKeyboard.Markup);
            
            UserDB.ChangeUserAction(context, chatId, Actions.ChoosingTags);
        }
        
        [UserAction(Actions.SearchingTags)]
        public async Task OnSearchingTags(ApplicationContext context, Message message, TelegramBotClient client)
        {
            var chatId = message.Chat.Id;
            var text = message.Text;

            User user = await UserDB.GetUserByChatId(context, chatId);
            
            TelegramKeyboard keyboard = new TelegramKeyboard();
            TelegramKeyboard keyboardMenu = new TelegramKeyboard();
            TelegramInlineKeyboard inlineKeyboard = new TelegramInlineKeyboard();
            
            List<UserTag> userTags = context.UserTags.Where(x => x.UserId == user.UserId).ToList();
            List<Tag> parentTags = context.Tags.Where(x => x.Level == 1).ToList();
            string[][] tags = new string[parentTags.Count-1][]; // Array of Tags of this Parent Tag (will be in DB, I guess) for INLINE keyboard
            string chosenTags = "";
            
            // Gets users callbacks from inline keyboard and receiving answers from normal keyboard
            switch (text)
            {
                case "–û–ö": // Shows all Networking buttons 
                    keyboardMenu.AddRow("–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å");
                    keyboardMenu.AddRow("–ó–∞–ø–∏—Å–Ω–∞—è –∫–Ω–∏–∂–∫–∞");
                    keyboardMenu.AddRow("–ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥");
                    keyboardMenu.AddRow("–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é");
                    
                    await client.SendTextMessageAsync(
                        chatId, "–ü–æ–∑–¥—Ä–∞–≤–ª—è—é ü•≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞ –æ–±—â–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!" +
                                "\n\nüìù –í **–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å** –≤—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ –∏ –∏–∑–º–µ–Ω—è—Ç—å —Ç–µ–≥–∏" +
                                "\n\nüìí –í **–ó–∞–ø–∏—Å–Ω–æ–π –∫–Ω–∏–∂–∫–µ** —Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã" +
                                "\n\n‚òïÔ∏è **–û–±—â–µ–Ω–∏–µ** –∑–∞–ø—É—Å—Ç–∏—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é. –í –Ω–µ–π –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –ª—é–¥–µ–π –≤ **–∫–Ω–∏–∂–∫—É** –∏–ª–∏ –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –∏—Ö –Ω–∞ **–≤—Å—Ç—Ä–µ—á—É**", 
                        ParseMode.Markdown, replyMarkup: keyboardMenu.Markup);
                    
                    break;
                
                case "–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥": // Add new parent tag
                    UserDB.ChangeUserAction(context, chatId, Actions.AddingParentTag);
                    
                    context.UserTags.RemoveRange(userTags); // Delete ALL previous tags

                    foreach (var parentTag in parentTags)
                    {
                        keyboard.AddRow(parentTag.Name);
                    }
                    
                    if (context.UserTags.FirstOrDefault(x => x.UserId == user.UserId) != null)
                    {
                        foreach (var tag in user.UserTags.Where(x => x.UserId == user.UserId))
                        {
                            chosenTags += context.Tags.FirstOrDefault(x => x.TagId == tag.TagId && x.Level == 1).Name + " "; 
                        }

                        await client.SendTextMessageAsync(
                            chatId, "–í—ã –≤—ã–±—Ä–∞–ª–∏: " + chosenTags, ParseMode.Markdown);
                    }
                    
                    await client.SendTextMessageAsync(
                        chatId, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø–æ–ª—å–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–≥:", 
                        ParseMode.Markdown, replyMarkup: keyboard.Markup);
                    break;
                
                case "–í—ã–±—Ä–∞—Ç—å –∑–∞–Ω–æ–≤–æ": // Returns to Action with Parent Tags? Deletes all tags that user has now
                    UserDB.ChangeUserAction(context, chatId, Actions.AddingParentTag);
                    
                    context.UserTags.RemoveRange(userTags); // Delete ALL previous tags

                    foreach (var parentTag in parentTags)
                    {
                        keyboard.AddRow(parentTag.Name);
                    }
                    
                    await client.SendTextMessageAsync(
                        chatId, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥: ", 
                        ParseMode.Markdown, replyMarkup: keyboard.Markup);
                    break;
                
                default: // if it's a TagID, add it
                    try
                    {
                        int id = Convert.ToInt32(text);
                    }
                    catch
                    {
                        break;
                    }

                    if (context.Tags.FirstOrDefault(x => x.TagId == Convert.ToInt32(text)) != null)
                    {
                        Tag tag = context.Tags.FirstOrDefault(x => x.TagId == Convert.ToInt32(text));
                        
                        UserTag userTag = new UserTag();
                        userTag.TagId = tag.TagId;
                        userTag.UserId = user.UserId;
                        userTag.ForSearching = true;
                        context.UserTags.Add(userTag);
                        context.SaveChanges();
                        
                        await client.SendTextMessageAsync(
                            chatId, "–¢–µ–≥ " + tag.Name + " –¥–æ–±–∞–≤–ª–µ–Ω.", 
                            ParseMode.Markdown);
                        break;
                    }
                    else
                    {
                        break;
                    }
            }
        }
        #endregion
    }
}